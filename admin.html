<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - PQRS Transporte HB</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="admin-container">
    <!-- Header -->
    <header class="admin-header">
        <div class="admin-header-left">
            <img src="assets/logo.png" alt="Logo Transporte HB" class="admin-logo">
            <h1>Panel de Administración PQRS</h1>
        </div>
        <div class="user-info">
            <div class="user-avatar" id="userInitial">
                <i class="fas fa-user"></i>
            </div>
            <span id="userEmail" style="color: white; margin-right: 10px;">admin@transportehb.com.co</span>
            <button id="logoutBtn" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
        </div>
    </header>

    <!-- Contenido principal -->
    <main class="admin-main">
        <!-- Dashboard de estadísticas -->
        <section class="dashboard">
            <div class="dashboard-card">
                <h3><i class="fas fa-file-alt"></i> Total Reportes</h3>
                <div class="stat-number" id="totalReports">0</div>
                <div class="stat-change" id="totalChange">
                    <i class="fas fa-chart-line"></i> Cargando...
                </div>
            </div>
            
            <div class="dashboard-card">
                <h3><i class="fas fa-clock"></i> Pendientes</h3>
                <div class="stat-number" id="pendingReports">0</div>
                <div class="stat-change negative">
                    <i class="fas fa-exclamation-circle"></i> Requieren atención
                </div>
            </div>
            
            <div class="dashboard-card">
                <h3><i class="fas fa-spinner"></i> En Proceso</h3>
                <div class="stat-number" id="inProgressReports">0</div>
                <div class="stat-change">
                    <i class="fas fa-check-circle"></i> En seguimiento
                </div>
            </div>
            
            <div class="dashboard-card">
                <h3><i class="fas fa-check-circle"></i> Resueltos</h3>
                <div class="stat-number" id="resolvedReports">0</div>
                <div class="stat-change">
                    <i class="fas fa-thumbs-up"></i> Completados
                </div>
            </div>
        </section>

        <!-- Filtros -->
        <section class="filters-section">
            <h2><i class="fas fa-filter"></i> Filtros de Búsqueda</h2>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterTipo">Tipo de Reporte</label>
                    <select id="filterTipo">
                        <option value="">Todos los tipos</option>
                        <option value="Queja">Queja</option>
                        <option value="Reclamo">Reclamo</option>
                        <option value="Peticion">Petición</option>
                        <option value="Felicitaciones">Felicitaciones</option>
                        <option value="Sugerencia">Sugerencia</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterCliente">Cliente</label>
                    <select id="filterCliente">
                        <option value="">Todos los clientes</option>
                        <option value="Argos">Argos</option>
                        <option value="Ecopetrol">Ecopetrol</option>
                        <option value="Puerto Bahía">Puerto Bahía</option>
                        <option value="Contecar">Contecar</option>
                        <option value="Italco">Italco</option>
                        <option value="Americas">Americas</option>
                        <option value="Hotel Hilton">Hotel Hilton</option>
                        <option value="Cementos País">Cementos País</option>
                        <option value="Ajover">Ajover</option>
                        <option value="Cimaco">Cimaco</option>
                        <option value="Proelectrica">Proelectrica</option>
                        <option value="Axalta">Axalta</option>
                        <option value="Counques">Counques</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterEstado">Estado</label>
                    <select id="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En proceso">En proceso</option>
                        <option value="Resuelto">Resuelto</option>
                        <option value="Cerrado">Cerrado</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterFechaDesde">Fecha Desde</label>
                    <input type="date" id="filterFechaDesde">
                </div>
                
                <div class="filter-group">
                    <label for="filterFechaHasta">Fecha Hasta</label>
                    <input type="date" id="filterFechaHasta">
                </div>
            </div>
            
            <div class="filter-actions">
                <button id="applyFilters" class="btn btn-primary">
                    <i class="fas fa-search"></i> Aplicar Filtros
                </button>
                <button id="clearFilters" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> Limpiar Filtros
                </button>
                <button id="toggleCharts" class="btn btn-secondary">
                    <i class="fas fa-chart-bar"></i> Mostrar Gráficos
                </button>
            </div>
        </section>

        <!-- Tabla de reportes -->
        <section class="reports-section">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> Reportes PQRS</h2>
                <div>
                    <button id="exportBtn" class="export-btn">
                        <i class="fas fa-download"></i> Exportar a CSV
                    </button>
                    <button id="refreshBtn" class="export-btn" style="background: var(--secondary-color); margin-left: 10px;">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="reports-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Tipo</th>
                            <th>Cliente</th>
                            <th>Reportante</th>
                            <th>Fecha Reporte</th>
                            <th>Placa</th>
                            <th>Conductor</th>
                            <th>Estado</th>
                            <th>Fecha Creación</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="reportsBody">
                        <!-- Los reportes se cargarán aquí dinámicamente -->
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--secondary-color);"></i>
                                    <p style="margin-top: 15px;">Cargando reportes...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación -->
            <div class="pagination">
                <button id="prevPage" class="pagination-btn" disabled>
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                
                <div class="page-numbers">
                    <span class="page-number active">1</span>
                </div>
                
                <button id="nextPage" class="pagination-btn">
                    Siguiente <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

<!-- Sección de gráficos -->
<section class="charts-section" id="chartsSection" style="display: none;">
    <div class="chart-card">
        <h3><i class="fas fa-chart-pie"></i> Distribución por Tipo</h3>
        <div class="chart-container">
            <canvas id="typeChart" width="400" height="300"></canvas>
        </div>
    </div>
    
    <div class="chart-card">
        <h3><i class="fas fa-chart-bar"></i> Reportes por Estado</h3>
        <div class="chart-container">
            <canvas id="statusChart" width="400" height="300"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <h3><i class="fas fa-chart-line"></i> Tendencia Mensual</h3>
        <div class="chart-container">
            <canvas id="trendChart" width="400" height="300"></canvas>
        </div>
    </div>
    
    <div class="chart-card">
        <h3><i class="fas fa-users"></i> Top 5 Clientes</h3>
        <div class="chart-container">
            <canvas id="clientsChart" width="400" height="300"></canvas>
        </div>
    </div>
</section>
    </main>

    <!-- Modal para detalles del reporte -->
    <div id="detailModal" class="modal" style="display: none;">
        <!-- El contenido se cargará dinámicamente -->
    </div>

    <!-- Modal para cambiar estado -->
    <div id="statusModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Cambiar Estado</h3>
                <button class="close-modal" onclick="closeStatusModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newStatus">Nuevo Estado</label>
                    <select id="newStatus" class="form-control">
                        <option value="Pendiente">Pendiente</option>
                        <option value="En proceso">En proceso</option>
                        <option value="Resuelto">Resuelto</option>
                        <option value="Cerrado">Cerrado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="statusComment">Comentario (opcional)</label>
                    <textarea id="statusComment" class="form-control" rows="3" placeholder="Agregar comentario sobre el cambio de estado..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStatusModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveStatusChange()">Guardar Cambio</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
<!-- AL FINAL DEL BODY -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Chart.js DEBE estar ANTES de nuestros scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Nuestros scripts en ORDEN CORRECTO -->
<script src="js/firebase-config.js"></script>
<script src="js/auth.js"></script>
<script src="js/admin.js"></script>          <!-- Carga datos -->
<script src="js/admin-charts.js"></script>   <!-- Usa datos -->
<script src="js/diagnostico.js"></script>    <!-- Temporal para depurar -->
    <script>
        // Script adicional para gráficos
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar email del usuario
            const user = firebase.auth().currentUser;
            if (user && user.email) {
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userInitial').innerHTML = user.email.charAt(0).toUpperCase();
            }

            // Toggle gráficos
            document.getElementById('toggleCharts').addEventListener('click', function() {
                const chartsSection = document.getElementById('chartsSection');
                const icon = this.querySelector('i');
                if (chartsSection.style.display === 'none') {
                    chartsSection.style.display = 'grid';
                    this.innerHTML = '<i class="fas fa-chart-bar"></i> Ocultar Gráficos';
                    loadCharts();
                } else {
                    chartsSection.style.display = 'none';
                    this.innerHTML = '<i class="fas fa-chart-bar"></i> Mostrar Gráficos';
                }
            });

            // Botón de actualizar
            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadReports();
                this.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Actualizando...';
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-sync-alt"></i> Actualizar';
                }, 2000);
            });
        });

        let charts = {};
        let currentReportId = '';

        function loadCharts() {
            // Esta función se llamará desde admin.js cuando se carguen los reportes
            setTimeout(() => {
                if (window.allReports && window.allReports.length > 0) {
                    createTypeChart();
                    createStatusChart();
                    createTrendChart();
                    createClientsChart();
                }
            }, 1000);
        }

        function createTypeChart() {
            const ctx = document.getElementById('typeChart').getContext('2d');
            
            // Contar por tipo
            const counts = {
                'Queja': 0, 'Reclamo': 0, 'Peticion': 0, 
                'Felicitaciones': 0, 'Sugerencia': 0
            };
            
            window.allReports.forEach(report => {
                counts[report.tipo_reporte] = (counts[report.tipo_reporte] || 0) + 1;
            });

            // Destruir gráfico anterior si existe
            if (charts.typeChart) {
                charts.typeChart.destroy();
            }

            charts.typeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Tipos de Reporte'
                        }
                    }
                }
            });
        }

        function createStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            // Contar por estado
            const counts = {
                'Pendiente': 0, 'En proceso': 0, 'Resuelto': 0, 'Cerrado': 0
            };
            
            window.allReports.forEach(report => {
                counts[report.estado] = (counts[report.estado] || 0) + 1;
            });

            // Destruir gráfico anterior si existe
            if (charts.statusChart) {
                charts.statusChart.destroy();
            }

            charts.statusChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        label: 'Cantidad de Reportes',
                        data: Object.values(counts),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#4BC0C0', '#9966FF'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Reportes por Estado'
                        }
                    }
                }
            });
        }

        function createTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Agrupar por mes
            const monthlyData = {};
            window.allReports.forEach(report => {
                const date = new Date(report.fecha_creacion);
                const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                monthlyData[monthYear] = (monthlyData[monthYear] || 0) + 1;
            });

            // Ordenar por fecha
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map(Number);
                const [monthB, yearB] = b.split('/').map(Number);
                return new Date(yearA, monthA - 1) - new Date(yearB, monthB - 1);
            });

            const labels = sortedMonths;
            const data = sortedMonths.map(month => monthlyData[month]);

            // Destruir gráfico anterior si existe
            if (charts.trendChart) {
                charts.trendChart.destroy();
            }

            charts.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Reportes por Mes',
                        data: data,
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tendencia Mensual de Reportes'
                        }
                    }
                }
            });
        }

        function createClientsChart() {
            const ctx = document.getElementById('clientsChart').getContext('2d');
            
            // Contar por cliente
            const clientCounts = {};
            window.allReports.forEach(report => {
                if (report.cliente) {
                    clientCounts[report.cliente] = (clientCounts[report.cliente] || 0) + 1;
                }
            });

            // Ordenar y tomar top 5
            const sortedClients = Object.entries(clientCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const labels = sortedClients.map(([client]) => client);
            const data = sortedClients.map(([, count]) => count);

            // Destruir gráfico anterior si existe
            if (charts.clientsChart) {
                charts.clientsChart.destroy();
            }

            charts.clientsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Top 5 Clientes con más Reportes'
                        }
                    }
                }
            });
        }

        // Funciones para modales
        function openStatusModal(reportId) {
            currentReportId = reportId;
            document.getElementById('statusModal').style.display = 'flex';
        }

        function closeStatusModal() {
            document.getElementById('statusModal').style.display = 'none';
            currentReportId = '';
            document.getElementById('statusComment').value = '';
        }

        async function saveStatusChange() {
            const newStatus = document.getElementById('newStatus').value;
            const comment = document.getElementById('statusComment').value;

            if (!currentReportId || !newStatus) {
                alert('Error: No se pudo identificar el reporte');
                return;
            }

            try {
                // Obtener reporte actual
                const snapshot = await firebase.database().ref(`pqrs_reports/${currentReportId}`).once('value');
                const report = snapshot.val();

                // Actualizar estado
                await firebase.database().ref(`pqrs_reports/${currentReportId}`).update({
                    estado: newStatus,
                    fecha_actualizacion: new Date().toISOString()
                });

                // Agregar comentario si existe
                if (comment.trim()) {
                    let comments = report.comentarios_internos || [];
                    const newComment = {
                        author: 'Administrador',
                        date: new Date().toISOString(),
                        text: `Cambio de estado a "${newStatus}": ${comment}`
                    };

                    if (typeof comments === 'string' && comments.trim()) {
                        comments = [{
                            author: 'Sistema',
                            date: report.fecha_creacion,
                            text: comments
                        }, newComment];
                    } else if (Array.isArray(comments)) {
                        comments.push(newComment);
                    } else {
                        comments = [newComment];
                    }

                    await firebase.database().ref(`pqrs_reports/${currentReportId}`).update({
                        comentarios_internos: comments
                    });
                }

                alert('Estado actualizado correctamente');
                closeStatusModal();
                loadReports(); // Recargar la tabla

            } catch (error) {
                console.error('Error al actualizar estado:', error);
                alert('Error al actualizar el estado: ' + error.message);
            }
        }

        // Cerrar modales al hacer clic fuera
        window.addEventListener('click', function(event) {
            const statusModal = document.getElementById('statusModal');
            if (event.target === statusModal) {
                closeStatusModal();
            }
        });
    </script>
</body>
</html>